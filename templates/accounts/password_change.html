{% extends 'base_auth.html' %}

{% block title %}Changer le mot de passe{% endblock %}

{% block auth_title %}Changement de mot de passe{% endblock %}

{% block auth_subtitle %}{% if user.must_change_password %}Changement obligatoire{% else %}Mise à jour de sécurité{% endif %}{% endblock %}

{% block content %}
{% if user.must_change_password %}
<div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Changement de mot de passe obligatoire :</strong> Vous devez changer votre mot de passe avant de pouvoir accéder aux autres fonctionnalités du système.
</div>
{% endif %}

<form method="post" id="passwordChangeForm">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger" role="alert">
        {% for error in form.non_field_errors %}
        <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
        {% endfor %}
    </div>
    {% endif %}

    {% for field in form %}
    <div class="mb-4">
        <label for="{{ field.id_for_label }}" class="form-label">
            <i class="fas fa-{% if 'old' in field.name %}lock{% elif 'new' in field.name %}key{% else %}check-double{% endif %} me-2"></i>
            {{ field.label }}
        </label>
        {{ field }}
        {% if field.help_text %}
        <small class="form-text text-muted">{{ field.help_text }}</small>
        {% endif %}
        {% for error in field.errors %}
        <div class="text-danger small mt-1">
            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
        </div>
        {% endfor %}
        
        {% if 'new_password1' in field.name %}
        <!-- Indicateurs de validation du mot de passe -->
        <div class="password-requirements mt-3" id="passwordRequirements" style="display: none;">
            <h6 class="mb-2" style="font-size: 0.9rem; font-weight: 600; color: #495057;">
                <i class="fas fa-shield-alt me-2"></i>Exigences du mot de passe :
            </h6>
            <div class="requirements-list">
                <div class="requirement-item invalid" data-requirement="length">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Au moins {{ password_settings.min_length|default:8 }} caractères</span>
                </div>
                {% if password_settings.require_uppercase %}
                <div class="requirement-item invalid" data-requirement="uppercase">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Lettres majuscules requises</span>
                </div>
                {% endif %}
                {% if password_settings.require_lowercase %}
                <div class="requirement-item invalid" data-requirement="lowercase">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Lettres minuscules requises</span>
                </div>
                {% endif %}
                {% if password_settings.require_numbers %}
                <div class="requirement-item invalid" data-requirement="numbers">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Chiffres requis</span>
                </div>
                {% endif %}
                {% if password_settings.require_special %}
                <div class="requirement-item invalid" data-requirement="special">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Caractères spéciaux requis</span>
                </div>
                {% endif %}
                <div class="requirement-item invalid" data-requirement="different">
                    <span class="requirement-icon"><i class="fas fa-times-circle"></i></span>
                    <span class="requirement-text">Le nouveau mot de passe doit être différent de l'ancien</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}

    <div class="d-grid gap-2 mt-4">
        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
            <i class="fas fa-save me-2"></i>Changer le mot de passe
        </button>
        {% if not user.must_change_password %}
        <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-2"></i>Annuler
        </a>
        {% endif %}
    </div>
</form>

<style>
.password-requirements {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 0.75rem;
}

.requirements-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.requirement-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.3s ease;
}

.requirement-icon {
    width: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.requirement-item.valid {
    color: #198754;
}

.requirement-item.valid .requirement-icon {
    color: #198754;
}

.requirement-item.invalid {
    color: #6c757d;
}

.requirement-item.invalid .requirement-icon {
    color: #dc3545;
}

.requirement-text {
    flex: 1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPasswordField = document.getElementById('id_new_password1');
    const oldPasswordField = document.getElementById('id_old_password');
    const requirementsDiv = document.getElementById('passwordRequirements');
    const requirementItems = document.querySelectorAll('.requirement-item');
    
    // Afficher les exigences quand l'utilisateur commence à taper
    if (newPasswordField) {
        newPasswordField.addEventListener('focus', function() {
            if (requirementsDiv) {
                requirementsDiv.style.display = 'block';
            }
        });
        
        newPasswordField.addEventListener('input', function() {
            validatePassword();
        });
    }
    
    if (oldPasswordField) {
        oldPasswordField.addEventListener('input', function() {
            validatePassword();
        });
    }
    
    function validatePassword() {
        const newPassword = newPasswordField ? newPasswordField.value : '';
        const oldPassword = oldPasswordField ? oldPasswordField.value : '';
        
        // Paramètres depuis le template
        const minLength = {{ password_settings.min_length|default:8 }};
        const requireUppercase = {{ password_settings.require_uppercase|yesno:"true,false"|default:"true" }};
        const requireLowercase = {{ password_settings.require_lowercase|yesno:"true,false"|default:"true" }};
        const requireNumbers = {{ password_settings.require_numbers|yesno:"true,false"|default:"true" }};
        const requireSpecial = {{ password_settings.require_special|yesno:"true,false"|default:"false" }};
        
        // Validation de la longueur
        const lengthValid = newPassword.length >= minLength;
        updateRequirement('length', lengthValid);
        
        // Validation majuscules
        if (requireUppercase) {
            const uppercaseValid = /[A-Z]/.test(newPassword);
            updateRequirement('uppercase', uppercaseValid);
        }
        
        // Validation minuscules
        if (requireLowercase) {
            const lowercaseValid = /[a-z]/.test(newPassword);
            updateRequirement('lowercase', lowercaseValid);
        }
        
        // Validation chiffres
        if (requireNumbers) {
            const numbersValid = /[0-9]/.test(newPassword);
            updateRequirement('numbers', numbersValid);
        }
        
        // Validation caractères spéciaux
        if (requireSpecial) {
            const specialValid = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
            updateRequirement('special', specialValid);
        }
        
        // Validation différence avec l'ancien mot de passe
        const differentValid = newPassword !== oldPassword && newPassword.length > 0;
        updateRequirement('different', differentValid);
    }
    
    function updateRequirement(requirementType, isValid) {
        const requirementItem = document.querySelector(`[data-requirement="${requirementType}"]`);
        if (requirementItem) {
            const icon = requirementItem.querySelector('.requirement-icon i');
            if (isValid) {
                requirementItem.classList.remove('invalid');
                requirementItem.classList.add('valid');
                if (icon) {
                    icon.className = 'fas fa-check-circle';
                }
            } else {
                requirementItem.classList.remove('valid');
                requirementItem.classList.add('invalid');
                if (icon) {
                    icon.className = 'fas fa-times-circle';
                }
            }
        }
    }
    
    // Validation initiale si le champ a déjà une valeur
    if (newPasswordField && newPasswordField.value) {
        validatePassword();
    }
});
</script>
{% endblock %}