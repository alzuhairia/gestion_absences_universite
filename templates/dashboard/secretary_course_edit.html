{% extends 'base_secretary.html' %}

{% block title %}Modifier le Cours{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:secretary_dashboard' %}">Secrétariat</a></li>
<li class="breadcrumb-item"><a href="{% url 'dashboard:secretary_courses' %}">Cours</a></li>
<li class="breadcrumb-item active">Modifier</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit me-2"></i>Modifier le Cours
        </h1>
        <a href="{% url 'dashboard:secretary_courses' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Retour
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3 bg-warning text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>Modification du Cours
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Attention :</strong> La désactivation d'un cours affectera toutes les inscriptions et absences associées.
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.code_cours.id_for_label }}" class="form-label">Code du Cours</label>
                                {{ form.code_cours }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nom_cours.id_for_label }}" class="form-label">Nom du Cours</label>
                                {{ form.nom_cours }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nombre_total_periodes.id_for_label }}" class="form-label">Total Périodes (h)</label>
                                {{ form.nombre_total_periodes }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.seuil_absence.id_for_label }}" class="form-label">Seuil d'Absence (%)</label>
                                {{ form.seuil_absence }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.id_departement.id_for_label }}" class="form-label">Département</label>
                                {{ form.id_departement }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.niveau.id_for_label }}" class="form-label">Niveau d'étude <span class="text-danger">*</span></label>
                                {{ form.niveau }}
                                {% if form.niveau.errors %}
                                <div class="text-danger small">{{ form.niveau.errors }}</div>
                                {% endif %}
                                {% if form.niveau.help_text %}
                                <small class="form-text text-muted">{{ form.niveau.help_text }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if form.id_annee %}
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Année académique :</strong> {{ course.id_annee.libelle|default:"Non définie" }}
                                </div>
                                {{ form.id_annee }}
                            </div>
                        </div>
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.professeur.id_for_label }}" class="form-label">Professeur Responsable</label>
                                {{ form.professeur }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.prerequisites.id_for_label }}" class="form-label">
                                <i class="fas fa-list-check me-2"></i>Prérequis
                            </label>
                            <div id="prerequisites-info" class="alert alert-info mb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="prerequisites-message">
                                    {% if course.niveau == 1 %}
                                        Année 1 : Aucun prérequis autorisé.
                                    {% elif course.niveau == 2 %}
                                        Année 2 : Prérequis autorisés uniquement depuis l'Année 1.
                                    {% elif course.niveau == 3 %}
                                        Année 3 : Prérequis autorisés uniquement depuis l'Année 1 ou 2.
                                    {% else %}
                                        Sélectionnez un niveau pour voir les prérequis disponibles.
                                    {% endif %}
                                </span>
                            </div>
                            <div class="prerequisites-container" id="prerequisites-container" style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.75rem; background-color: #f8f9fa;">
                                {% if form.prerequisites.field.queryset.exists %}
                                    {% for checkbox in form.prerequisites %}
                                        <div class="form-check mb-2">
                                            {{ checkbox.tag }}
                                            <label class="form-check-label" for="{{ checkbox.id_for_label }}" style="cursor: pointer; user-select: none;">
                                                {{ checkbox.choice_label }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Aucun autre cours disponible. Créez d'abord d'autres cours pour pouvoir définir des prérequis.
                                    </p>
                                {% endif %}
                            </div>
                            {% if form.prerequisites.help_text %}
                            <small class="form-text text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>{{ form.prerequisites.help_text }}
                            </small>
                            {% endif %}
                            {% if form.prerequisites.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.prerequisites.errors %}
                                <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.actif }}
                            <label class="form-check-label" for="{{ form.actif.id_for_label }}">
                                Actif
                            </label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Enregistrer les modifications
                            </button>
                            <a href="{% url 'dashboard:secretary_courses' %}" class="btn btn-secondary">
                                Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ============================================
 * GESTION DYNAMIQUE DES PRÉREQUIS PAR NIVEAU
 * ============================================
 * 
 * IMPORTANT POUR LA SOUTENANCE :
 * Ce JavaScript implémente la règle métier de filtrage des prérequis :
 * - Un cours de niveau N ne peut avoir que des prérequis de niveau < N
 * - Le filtrage est dynamique : quand le niveau change, les prérequis disponibles sont rechargés
 * - Cela évite les incohérences (ex: un cours de niveau 1 avec un prérequis de niveau 2)
 * 
 * Logique :
 * - Niveau 1 : Aucun prérequis autorisé
 * - Niveau 2 : Prérequis autorisés uniquement depuis le niveau 1
 * - Niveau 3 : Prérequis autorisés depuis les niveaux 1 ou 2
 */

// Attendre que le DOM soit chargé avant d'exécuter le script
document.addEventListener('DOMContentLoaded', function() {
    // Récupération des éléments du formulaire
    const niveauField = document.getElementById('{{ form.niveau.id_for_label }}');
    const prerequisitesContainer = document.getElementById('prerequisites-container');
    const prerequisitesMessage = document.getElementById('prerequisites-message');
    const courseId = {{ course.id_cours }};
    
    /**
     * Charge dynamiquement les prérequis disponibles selon le niveau sélectionné.
     * 
     * IMPORTANT POUR LA SOUTENANCE :
     * Cette fonction fait un appel API pour récupérer uniquement les prérequis
     * autorisés selon le niveau du cours. Cela garantit la cohérence des données.
     * 
     * Logique :
     * 1. Récupère le niveau sélectionné
     * 2. Fait un appel API GET vers /dashboard/api/prerequisites-by-level/
     * 3. Affiche uniquement les prérequis autorisés (niveau < niveau du cours)
     * 4. Met à jour le message informatif
     */
    async function loadPrerequisites() {
        const niveau = niveauField ? niveauField.value : null;
        
        if (!niveau) {
            return;
        }
        
        // Mettre à jour le message
        if (prerequisitesMessage) {
            if (niveau == '1') {
                prerequisitesMessage.textContent = 'Année 1 : Aucun prérequis autorisé.';
            } else if (niveau == '2') {
                prerequisitesMessage.textContent = 'Année 2 : Prérequis autorisés uniquement depuis l\'Année 1.';
            } else if (niveau == '3') {
                prerequisitesMessage.textContent = 'Année 3 : Prérequis autorisés uniquement depuis l\'Année 1 ou 2.';
            }
        }
        
        // ============================================
        // CHARGEMENT DYNAMIQUE DES PRÉREQUIS
        // ============================================
        // Appel API pour récupérer uniquement les prérequis autorisés selon le niveau
        
        if (prerequisitesContainer) {
            // Afficher un indicateur de chargement
            prerequisitesContainer.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Chargement des prérequis...</p>';
            
            try {
                // Appel API : récupère les prérequis filtrés par niveau
                // L'API retourne uniquement les cours de niveau < niveau du cours actuel
                const response = await fetch(`/dashboard/api/prerequisites-by-level/?niveau=${niveau}&course_id=${courseId}`);
                const data = await response.json();
                
                // Gestion des erreurs API
                if (data.error) {
                    prerequisitesContainer.innerHTML = `<p class="text-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>${data.error}</p>`;
                    return;
                }
                
                // Cas : Aucun prérequis disponible
                if (data.length === 0) {
                    if (niveau == '1') {
                        // Niveau 1 : normal qu'il n'y ait pas de prérequis
                        prerequisitesContainer.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Année 1 : Aucun prérequis autorisé.</p>';
                    } else {
                        // Niveaux 2 ou 3 : pas de cours disponibles comme prérequis
                        prerequisitesContainer.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Aucun cours disponible comme prérequis pour ce niveau.</p>';
                    }
                    return;
                }
                
                // ============================================
                // PRÉSERVATION DES PRÉREQUIS DÉJÀ SÉLECTIONNÉS
                // ============================================
                // IMPORTANT : Conserver les prérequis déjà sélectionnés lors du changement de niveau
                // Cela évite de perdre les sélections si l'utilisateur change le niveau par erreur
                
                const currentPrerequisites = [];
                prerequisitesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    currentPrerequisites.push(parseInt(cb.value));
                });
                
                // ============================================
                // CRÉATION DES CHECKBOXES DE PRÉREQUIS
                // ============================================
                // Générer dynamiquement les checkboxes pour chaque prérequis disponible
                // Cocher automatiquement ceux qui étaient déjà sélectionnés
                
                let html = '';
                data.forEach(course => {
                    const checkboxId = `id_prerequisites_${course.id}`;
                    // Préserver la sélection si le prérequis était déjà coché
                    const isChecked = currentPrerequisites.includes(course.id) ? 'checked' : '';
                    html += `
                        <div class="form-check mb-2">
                            <input type="checkbox" name="prerequisites" value="${course.id}" class="form-check-input" id="${checkboxId}" ${isChecked}>
                            <label class="form-check-label" for="${checkboxId}" style="cursor: pointer; user-select: none;">
                                ${course.display}
                            </label>
                        </div>
                    `;
                });
                
                prerequisitesContainer.innerHTML = html;
            } catch (error) {
                // Gestion des erreurs (réseau, serveur, etc.)
                console.error('Erreur:', error);
                prerequisitesContainer.innerHTML = '<p class="text-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>Erreur lors du chargement des prérequis.</p>';
            }
        }
    }
    
    // ============================================
    // ÉCOUTEUR D'ÉVÉNEMENT
    // ============================================
    // Recharger les prérequis automatiquement quand le niveau change
    // Cela garantit que seuls les prérequis autorisés sont affichés
    
    if (niveauField) {
        niveauField.addEventListener('change', loadPrerequisites);
    }
});
</script>
{% endblock %}

