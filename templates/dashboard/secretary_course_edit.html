{% extends 'base_secretary.html' %}

{% block title %}Modifier le Cours{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:secretary_dashboard' %}">Secrétariat</a></li>
<li class="breadcrumb-item"><a href="{% url 'dashboard:secretary_courses' %}">Cours</a></li>
<li class="breadcrumb-item active">Modifier</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-edit me-2"></i>Modifier le Cours
        </h1>
        <a href="{% url 'dashboard:secretary_courses' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Retour
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header py-3 bg-warning text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>Modification du Cours
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Attention :</strong> La désactivation d'un cours affectera toutes les inscriptions et absences associées.
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.code_cours.id_for_label }}" class="form-label">Code du Cours</label>
                                {{ form.code_cours }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nom_cours.id_for_label }}" class="form-label">Nom du Cours</label>
                                {{ form.nom_cours }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nombre_total_periodes.id_for_label }}" class="form-label">Total Périodes (h)</label>
                                {{ form.nombre_total_periodes }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.seuil_absence.id_for_label }}" class="form-label">Seuil d'Absence (%)</label>
                                {{ form.seuil_absence }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.id_departement.id_for_label }}" class="form-label">Département</label>
                                {{ form.id_departement }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.niveau.id_for_label }}" class="form-label">Niveau d'étude <span class="text-danger">*</span></label>
                                {{ form.niveau }}
                                {% if form.niveau.errors %}
                                <div class="text-danger small">{{ form.niveau.errors }}</div>
                                {% endif %}
                                {% if form.niveau.help_text %}
                                <small class="form-text text-muted">{{ form.niveau.help_text }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if form.id_annee %}
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Année académique :</strong> {{ course.id_annee.libelle|default:"Non définie" }}
                                </div>
                                {{ form.id_annee }}
                            </div>
                        </div>
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.professeur.id_for_label }}" class="form-label">Professeur Responsable</label>
                                {{ form.professeur }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.prerequisites.id_for_label }}" class="form-label">
                                <i class="fas fa-list-check me-2"></i>Prérequis
                            </label>
                            <div id="prerequisites-info" class="alert alert-info mb-2" role="status" aria-live="polite">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="prerequisites-message">
                                    {% if course.niveau == 1 %}
                                        Année 1 : Aucun prérequis autorisé.
                                    {% elif course.niveau == 2 %}
                                        Année 2 : Prérequis autorisés uniquement depuis l'Année 1.
                                    {% elif course.niveau == 3 %}
                                        Année 3 : Prérequis autorisés uniquement depuis l'Année 1 ou 2.
                                    {% else %}
                                        Sélectionnez un niveau pour voir les prérequis disponibles.
                                    {% endif %}
                                </span>
                            </div>
                            <div class="prerequisites-container" id="prerequisites-container" style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.75rem; background-color: #f8f9fa;" role="status" aria-live="polite">
                                {% if has_prerequisites_options %}
                                    {% for checkbox in form.prerequisites %}
                                        <div class="form-check mb-2">
                                            {{ checkbox.tag }}
                                            <label class="form-check-label" for="{{ checkbox.id_for_label }}" style="cursor: pointer; user-select: none;">
                                                {{ checkbox.choice_label }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Aucun autre cours disponible. Créez d'abord d'autres cours pour pouvoir définir des prérequis.
                                    </p>
                                {% endif %}
                            </div>
                            {% if form.prerequisites.help_text %}
                            <small class="form-text text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>{{ form.prerequisites.help_text }}
                            </small>
                            {% endif %}
                            {% if form.prerequisites.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.prerequisites.errors %}
                                <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.actif }}
                            <label class="form-check-label" for="{{ form.actif.id_for_label }}">
                                Actif
                            </label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Enregistrer les modifications
                            </button>
                            <a href="{% url 'dashboard:secretary_courses' %}" class="btn btn-secondary">
                                Annuler
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Gestion dynamique des prérequis par niveau.
 *
 * Règle métier : un cours de niveau N ne peut avoir que des prérequis de niveau < N.
 */
document.addEventListener('DOMContentLoaded', function() {
    const niveauField = document.getElementById('{{ form.niveau.id_for_label }}');
    const prerequisitesContainer = document.getElementById('prerequisites-container');
    const prerequisitesMessage = document.getElementById('prerequisites-message');
    const courseId = {{ course.id_cours }};

    const renderMessage = (message, type = 'muted', icon = 'fa-info-circle') => {
        if (!prerequisitesContainer) return;

        prerequisitesContainer.replaceChildren();
        const p = document.createElement('p');
        p.className = `text-${type} mb-0`;

        const i = document.createElement('i');
        i.className = `fas ${icon} me-2`;
        p.appendChild(i);
        p.appendChild(document.createTextNode(message));

        prerequisitesContainer.appendChild(p);
    };

    const renderCourses = (courses, selectedIds) => {
        if (!prerequisitesContainer) return;

        prerequisitesContainer.replaceChildren();
        courses.forEach(course => {
            const checkboxId = `id_prerequisites_${course.id}`;

            const wrapper = document.createElement('div');
            wrapper.className = 'form-check mb-2';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'prerequisites';
            input.value = String(course.id);
            input.className = 'form-check-input';
            input.id = checkboxId;
            input.checked = selectedIds.has(Number(course.id));

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = checkboxId;
            label.style.cursor = 'pointer';
            label.style.userSelect = 'none';
            label.textContent = course.display || '';

            wrapper.appendChild(input);
            wrapper.appendChild(label);
            prerequisitesContainer.appendChild(wrapper);
        });
    };
    const getApiErrorMessage = (payload) => {
        if (!payload || typeof payload !== 'object') {
            return '';
        }
        if (payload.error && typeof payload.error === 'object' && payload.error.message) {
            return String(payload.error.message);
        }
        if (typeof payload.error === 'string') {
            return payload.error;
        }
        return '';
    };

    const fetchJson = async (url) => {
        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        });
        const contentType = (response.headers.get('content-type') || '').toLowerCase();
        if (!contentType.includes('application/json')) {
            throw new Error('Session expirée ou réponse invalide.');
        }

        let data = null;
        try {
            data = await response.json();
        } catch (_) {
            throw new Error('Réponse API invalide.');
        }

        if (!response.ok) {
            throw new Error(getApiErrorMessage(data) || `HTTP ${response.status}`);
        }

        return data;
    };

    async function loadPrerequisites() {
        const niveau = niveauField ? niveauField.value : null;
        if (!niveau) {
            return;
        }

        if (prerequisitesMessage) {
            if (niveau === '1') {
                prerequisitesMessage.textContent = 'Année 1 : Aucun prérequis autorisé.';
            } else if (niveau === '2') {
                prerequisitesMessage.textContent = 'Année 2 : Prérequis autorisés uniquement depuis l\'Année 1.';
            } else if (niveau === '3') {
                prerequisitesMessage.textContent = 'Année 3 : Prérequis autorisés uniquement depuis l\'Année 1 ou 2.';
            }
        }

        const selectedIds = new Set();
        if (prerequisitesContainer) {
            prerequisitesContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedIds.add(Number(cb.value));
            });
        }

        renderMessage('Chargement des prérequis...', 'muted', 'fa-spinner fa-spin');

        try {
            const data = await fetchJson(`/dashboard/api/prerequisites-by-level/?niveau=${niveau}&course_id=${courseId}`);
            if (!Array.isArray(data)) {
                renderMessage('Réponse API invalide.', 'danger', 'fa-exclamation-circle');
                return;
            }

            if (data.length === 0) {
                if (niveau === '1') {
                    renderMessage('Année 1 : Aucun prérequis autorisé.');
                } else {
                    renderMessage('Aucun cours disponible comme prérequis pour ce niveau.');
                }
                return;
            }

            renderCourses(data, selectedIds);
        } catch (error) {
            console.error('Erreur:', error);
            renderMessage(error.message || 'Erreur lors du chargement des prérequis.', 'danger', 'fa-exclamation-circle');
        }
    }

    if (niveauField) {
        niveauField.addEventListener('change', loadPrerequisites);
    }
});
</script>
{% endblock %}



